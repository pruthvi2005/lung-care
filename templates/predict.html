{% extends "base.html" %}

{% block title %}Lung Cancer Risk Assessment{% endblock %}

{% block extra_css %}
<style>
    .question-card {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    .question-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    /* Custom styles for result modal */
    #resultModal.hidden {
        display: none;
    }
    .slider-thumb::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #3b82f6;
        cursor: pointer;
    }
    .slider-thumb::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #3b82f6;
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto p-4 md:p-8 max-w-4xl">
    <header class="text-center mb-8">
        <h1 class="text-4xl font-bold text-blue-600">Lung Cancer Risk Assessment</h1>
        <p class="text-gray-600 mt-2">Answer the questions below on a scale of 1 to 10 to estimate your risk level.</p>
        <p class="text-sm text-gray-500 mt-2"><strong>Note:</strong> For each factor, 1 represents the lowest severity or frequency, while 10 represents the highest.</p>
    </header>

    <main id="prediction-form" class="glass-card p-6 md:p-8">
        <form id="riskAssessmentForm" method="POST" action="{{ url_for('predict') }}">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Questions based on the dataset columns -->
                <div class="question-card bg-white p-5 rounded-lg border border-gray-200">
                    <label for="airPollution" class="block text-md font-medium text-gray-700 mb-2">Air Pollution Exposure</label>
                    <input type="range" id="airPollution" name="air_pollution" min="1" max="10" value="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider-thumb">
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span>1 (None)</span>
                        <span id="airPollutionValue" class="font-medium text-blue-600">5</span>
                        <span>10 (High)</span>
                    </div>
                </div>

                <div class="question-card bg-white p-5 rounded-lg border border-gray-200">
                    <label for="alcoholUse" class="block text-md font-medium text-gray-700 mb-2">Alcohol Consumption</label>
                    <input type="range" id="alcoholUse" name="alcohol_use" min="1" max="10" value="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider-thumb">
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span>1 (None)</span>
                        <span id="alcoholUseValue" class="font-medium text-blue-600">5</span>
                        <span>10 (Heavy)</span>
                    </div>
                </div>

                <div class="question-card bg-white p-5 rounded-lg border border-gray-200">
                    <label for="dustAllergy" class="block text-md font-medium text-gray-700 mb-2">Dust Allergy Severity</label>
                    <input type="range" id="dustAllergy" name="dust_allergy" min="1" max="10" value="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider-thumb">
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span>1 (None)</span>
                        <span id="dustAllergyValue" class="font-medium text-blue-600">5</span>
                        <span>10 (Severe)</span>
                    </div>
                </div>

                <div class="question-card bg-white p-5 rounded-lg border border-gray-200">
                    <label for="occupationalHazards" class="block text-md font-medium text-gray-700 mb-2">Occupational Hazards</label>
                    <input type="range" id="occupationalHazards" name="occupational_hazards" min="1" max="10" value="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider-thumb">
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span>1 (None)</span>
                        <span id="occupationalHazardsValue" class="font-medium text-blue-600">5</span>
                        <span>10 (High)</span>
                    </div>
                </div>

                <div class="question-card bg-white p-5 rounded-lg border border-gray-200">
                    <label for="geneticRisk" class="block text-md font-medium text-gray-700 mb-2">Genetic Risk</label>
                    <input type="range" id="geneticRisk" name="genetic_risk" min="1" max="10" value="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider-thumb">
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span>1 (None)</span>
                        <span id="geneticRiskValue" class="font-medium text-blue-600">5</span>
                        <span>10 (High)</span>
                    </div>
                </div>

                <div class="question-card bg-white p-5 rounded-lg border border-gray-200">
                    <label for="chronicLungDisease" class="block text-md font-medium text-gray-700 mb-2">History of Chronic Lung Disease</label>
                    <input type="range" id="chronicLungDisease" name="chronic_lung_disease" min="1" max="10" value="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider-thumb">
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span>1 (None)</span>
                        <span id="chronicLungDiseaseValue" class="font-medium text-blue-600">5</span>
                        <span>10 (Severe)</span>
                    </div>
                </div>

                <div class="question-card bg-white p-5 rounded-lg border border-gray-200">
                    <label for="smoking" class="block text-md font-medium text-gray-700 mb-2">Smoking Habit</label>
                    <input type="range" id="smoking" name="smoking" min="1" max="10" value="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider-thumb">
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span>1 (Never)</span>
                        <span id="smokingValue" class="font-medium text-blue-600">5</span>
                        <span>10 (Heavy)</span>
                    </div>
                </div>

                <div class="question-card bg-white p-5 rounded-lg border border-gray-200">
                    <label for="passiveSmoker" class="block text-md font-medium text-gray-700 mb-2">Passive Smoker Exposure</label>
                    <input type="range" id="passiveSmoker" name="passive_smoker" min="1" max="10" value="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider-thumb">
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span>1 (None)</span>
                        <span id="passiveSmokerValue" class="font-medium text-blue-600">5</span>
                        <span>10 (Heavy)</span>
                    </div>
                </div>

                <div class="question-card bg-white p-5 rounded-lg border border-gray-200">
                    <label for="fatigue" class="block text-md font-medium text-gray-700 mb-2">Fatigue Level</label>
                    <input type="range" id="fatigue" name="fatigue" min="1" max="10" value="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider-thumb">
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span>1 (None)</span>
                        <span id="fatigueValue" class="font-medium text-blue-600">5</span>
                        <span>10 (Severe)</span>
                    </div>
                </div>

                <div class="question-card bg-white p-5 rounded-lg border border-gray-200">
                    <label for="dryCough" class="block text-md font-medium text-gray-700 mb-2">Frequency of Dry Cough</label>
                    <input type="range" id="dryCough" name="dry_cough" min="1" max="10" value="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider-thumb">
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span>1 (Never)</span>
                        <span id="dryCoughValue" class="font-medium text-blue-600">5</span>
                        <span>10 (Constant)</span>
                    </div>
                </div>
            </div>

            <div class="mt-8 text-center">
                <button type="submit" id="predictBtn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition duration-300 shadow-md">
                    Assess My Risk
                </button>
            </div>
        </form>
    </main>
</div>

<!-- Result Modal -->
<div id="resultModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 transform transition-all duration-300 ease-in-out" id="modalContent">
        <div class="text-center">
            <h2 class="text-3xl font-bold mb-4" id="resultLevel">Your Risk Assessment</h2>
            <p class="text-gray-600 mb-2">Your calculated risk score is:</p>
            <div class="my-6">
                <div class="text-6xl font-extrabold mb-2" id="resultScore">0</div>
                <div class="w-full bg-gray-200 rounded-full h-4 mb-4 overflow-hidden">
                    <div id="resultBarFill" class="h-full transition-all duration-1000 ease-in-out"></div>
                </div>
                <p class="text-sm text-gray-500" id="resultRangeInfo">Score range: 0-9</p>
            </div>
            <p class="text-gray-700 mb-6" id="resultDescription"></p>
            
            <div id="lowRiskInfo" class="hidden bg-green-50 border-l-4 border-green-400 p-4 mb-6 text-left">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-green-700">Your risk level is low. Continue healthy habits and regular check-ups.</p>
                    </div>
                </div>
            </div>
            
            <div id="mediumRiskInfo" class="hidden bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 text-left">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-yellow-700">Moderate risk detected. Consider consulting a healthcare professional.</p>
                    </div>
                </div>
            </div>
            
            <div id="highRiskInfo" class="hidden bg-red-50 border-l-4 border-red-400 p-4 mb-6 text-left">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-red-700">High risk detected. We strongly recommend consulting a healthcare professional for a thorough evaluation.</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-blue-50 p-4 rounded-lg text-left mb-6">
                <h3 class="font-medium text-blue-800 mb-2">Recommendations:</h3>
                <ul class="list-disc pl-5 text-sm text-blue-700 space-y-1" id="recommendations">
                    <li>Schedule a check-up with your doctor</li>
                    <li>Consider lifestyle changes to reduce risk factors</li>
                    <li>Be aware of any persistent symptoms</li>
                </ul>
            </div>
            
            <p class="text-xs text-gray-500 mb-6">
                <strong>Disclaimer:</strong> This is an estimation based on the provided inputs and not a medical diagnosis. Consult a healthcare professional for an accurate assessment.
            </p>
            
            <div class="flex justify-center space-x-4">
                <button id="closeModalBtn" class="bg-gray-200 text-gray-800 font-medium py-2 px-6 rounded-lg hover:bg-gray-300 transition duration-300">
                    Close
                </button>
                <a href="{{ url_for('about') }}" class="bg-blue-100 text-blue-700 font-medium py-2 px-6 rounded-lg hover:bg-blue-200 transition duration-300">
                    Learn More
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Update slider values
        const updateSliderValue = (sliderId, valueId) => {
            const slider = document.getElementById(sliderId);
            const valueSpan = document.getElementById(valueId);
            if (slider && valueSpan) {
                valueSpan.textContent = slider.value;
                slider.addEventListener('input', (e) => {
                    valueSpan.textContent = e.target.value;
                });
            }
        };

        // Initialize all sliders
        const sliders = [
            { id: 'airPollution', valueId: 'airPollutionValue' },
            { id: 'alcoholUse', valueId: 'alcoholUseValue' },
            { id: 'dustAllergy', valueId: 'dustAllergyValue' },
            { id: 'occupationalHazards', valueId: 'occupationalHazardsValue' },
            { id: 'geneticRisk', valueId: 'geneticRiskValue' },
            { id: 'chronicLungDisease', valueId: 'chronicLungDiseaseValue' },
            { id: 'smoking', valueId: 'smokingValue' },
            { id: 'passiveSmoker', valueId: 'passiveSmokerValue' },
            { id: 'fatigue', valueId: 'fatigueValue' },
            { id: 'dryCough', valueId: 'dryCoughValue' }
        ];

        sliders.forEach(slider => {
            updateSliderValue(slider.id, slider.valueId);
        });

        // Form submission
        const form = document.getElementById('riskAssessmentForm');
        if (form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // In a real app, you would send the form data to the server here
                // For now, we'll simulate a response
                simulatePrediction();
            });
        }

        // Modal functionality
        const resultModal = document.getElementById('resultModal');
        const modalContent = document.getElementById('modalContent');
        const closeModalBtn = document.getElementById('closeModalBtn');

        function showModal() {
            resultModal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('opacity-0', 'translate-y-4');
            }, 10);
        }

        function hideModal() {
            modalContent.classList.add('opacity-0', 'translate-y-4');
            setTimeout(() => {
                resultModal.classList.add('hidden');
            }, 300);
        }

        if (closeModalBtn) {
            closeModalBtn.addEventListener('click', hideModal);
        }

        resultModal.addEventListener('click', (e) => {
            if (e.target === resultModal) {
                hideModal();
            }
        });

        // Simulate prediction (replace with actual API call)
        function simulatePrediction() {
            // Show loading state
            const predictBtn = document.getElementById('predictBtn');
            const originalBtnText = predictBtn.innerHTML;
            predictBtn.disabled = true;
            predictBtn.innerHTML = 'Analyzing...';

            // Simulate API call delay
            setTimeout(() => {
                // Calculate score (simple average of all inputs)
                let totalScore = 0;
                sliders.forEach(slider => {
                    totalScore += parseInt(document.getElementById(slider.id).value);
                });
                const averageScore = totalScore / sliders.length;
                const finalScore = Math.round(averageScore);

                // Determine risk level
                let level = '';
                let description = '';
                let barColor = '';
                let riskInfoId = '';

                if (finalScore <= 3) {
                    level = 'Low Risk';
                    description = 'Your risk level appears to be low. Maintaining a healthy lifestyle is key.';
                    barColor = 'bg-green-500';
                    riskInfoId = 'lowRiskInfo';
                } else if (finalScore <= 6) {
                    level = 'Medium Risk';
                    description = 'Your risk level is medium. Consider consulting a doctor about potential risk factors.';
                    barColor = 'bg-yellow-500';
                    riskInfoId = 'mediumRiskInfo';
                } else {
                    level = 'High Risk';
                    description = 'Your risk level is high. It is strongly recommended to consult a healthcare professional for a detailed checkup.';
                    barColor = 'bg-red-500';
                    riskInfoId = 'highRiskInfo';
                }

                // Update UI
                document.getElementById('resultLevel').textContent = level;
                document.getElementById('resultScore').textContent = finalScore;
                document.getElementById('resultDescription').textContent = description;
                
                // Set progress bar
                const resultBarFill = document.getElementById('resultBarFill');
                resultBarFill.className = `h-full transition-all duration-1000 ease-in-out ${barColor}`;
                resultBarFill.style.width = `${(finalScore / 10) * 100}%`;
                
                // Show appropriate risk info
                document.getElementById('lowRiskInfo').classList.add('hidden');
                document.getElementById('mediumRiskInfo').classList.add('hidden');
                document.getElementById('highRiskInfo').classList.add('hidden');
                document.getElementById(riskInfoId).classList.remove('hidden');
                
                // Show modal
                showModal();
                
                // Reset button
                predictBtn.disabled = false;
                predictBtn.innerHTML = originalBtnText;
            }, 1500); // Simulate network delay
        }
    });
</script>
{% endblock %}
